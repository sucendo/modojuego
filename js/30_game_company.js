const color = {
    cloakBg:'#110033',
    cloakOl:'#aa00ff',
    bone:'#eeffee',
    floorBg:'#110033',
    floorOl:'#9944ff66',
    brickBg:'#c16c45',
    brickOl:'#c93c20',
    doorBg:'#772200',
    doorOl:'#aa5500',
    jumpBg:'#552233',
    jumpOl:'#ff77ff66',
}

const LOCALSTORAGE_KEY = 'DeathsApprenticeJS13k2022BestTime';


class Game {
    constructor(canvas, leveldata) {
        this.canvas = canvas;
        this.levels = [];
        this.levelPointer = -1;
        this.player = null;
        this.initLevels(leveldata);
        this.musicPlaying = false;

        this.ctx = canvas.getContext('2d');
        this.width = this.canvas.width;
        this.height = this.canvas.height;
        this.objs = [];
        this.keys = {
            'KeyA':'l',
            'KeyD':'r',
            'KeyW':'j',
            'ArrowLeft':'l',
            'ArrowRight':'r',
            'ArrowUp':'j',
            'ShiftLeft':'d',
            'ShiftRight':'d'
        };
        this.actions = {
            l:false,
            r:false,
            j:false
        };
        let game = this;
        document.addEventListener('keydown', (ev)=> game.keydown(ev));
        document.addEventListener('keyup', (ev)=> game.keyup(ev));
        this.lastUpdate = Date.now();
        this.startTime = null;
        this.speedRunTime = null;
    }
    initLevels(leveldata) {
        this.levels = leveldata.split('\n#\n');
        this.levelPointer = -1;
    }
    finishedCurrentLevel() {
        if(this.levelPointer == this.levels.length - 2) {
            // finished last level with hourglass, stop timer
            this.speedRunTime = (Date.now() - this.startTime) / 1000.0;
            let currentBest = localStorage.getItem(LOCALSTORAGE_KEY);
            if(!currentBest || currentBest > this.speedRunTime) {
                localStorage.setItem(LOCALSTORAGE_KEY, this.speedRunTime);
            }
        }
        if(this.levelPointer >= this.levels.length - 1) {
            return; // no more levels
        }
        this.player.stopUpdates = true;
        let game = this;
        this.addObj(new LevelBlender({
            target:this.player,
            game:game,
            finishedCallback:(blendObj)=>{
                game.loadNextLevel();
            }
        }));
    }
    loadNextLevel() {
        if(this.levelPointer >= this.levels.length - 1) {
            return; // no more levels
        }
        this.levelPointer++;
        this.loadCurrentLevel();
    }
    loadCurrentLevel() {
        this.objs = [];
        this.player = null;
        let leveldata = this.levels[this.levelPointer];
        leveldata.split("ยง").forEach(levelObject => {
            let data = levelObject.split("~");
            if(data.length < 2) {
                return;
            }
            let obj = {};
            if(data.length >= 3) {
                obj.pos = new Vec(data[1] * 1, data[2] * 1);
            }
            if(['f','d','j','s'].indexOf(data[0]) > -1) {
                obj.size = new Vec(data[3] * 1, data[4] * 1);
            }
            if(data[0] == "f") {
                game.addObj(new Floor(obj));
            } else if(data[0] == "s") {
                obj.directionUp = data[5] == "1";
                game.addObj(new Spikes(obj));
            } else if(data[0] == "d") {
                obj.lock = data[5];
                game.addObj(new Door(obj));
            } else if(data[0] == "k") {
                obj.unlocking = data[3];
                game.addObj(new Key(obj));
            } else if(data[0] == "j") {
                obj.jumpforce = (data[5] || 1.5) * 1;
                game.addObj(new Jumppad(obj));
            } else if(data[0] == "p") {
                game.player = game.addObj(new Player(obj));
            } else if(data[0] == "h") {
                obj.startTime = data[3] * 1;
                game.addObj(new Hourglass(obj));
            } else if(data[0] == "t") {
                obj.text = data[3];
                if(game.speedRunTime) {
                    obj.text = obj.text.replace("{speedRunTime}", this.getTimeFormated(game.speedRunTime));
                    localStorage.getItem(LOCALSTORAGE_KEY);
                    obj.text = obj.text.replace("{bestTime}", this.getTimeFormated(localStorage.getItem(LOCALSTORAGE_KEY)));
                }
                obj.startTime = data[4] * 1;
                obj.textsize = data[5];
                game.addObj(new Text(obj));
            }
        });
        this.player.stopUpdates = true;
        this.player.stopRendering = true;
        this.addObj(new LevelBlender({
            target:this.player,
            game:game,
            radius:1,
            rate:-game.canvas.width,
            finishedCallback:(blendObj)=>{
                game.removeObj(blendObj);
                game.player.respawn();
            }
        }));
    }
    keydown(ev) {
        if(this.keys[ev.code]) {
            this.actions[this.keys[ev.code]] = true;
        }
        if(ev.code == 'KeyM') {
            if(this.musicPlaying) {
                audio.pause();
                this.musicPlaying = false;
            } else {
                audio.play();
                this.musicPlaying = true;
            }
        }
        if(ev.code == 'KeyO') {
            this.loadNextLevel();
        }
        if(this.levelPointer == 0 && !this.startTime) {
            this.startTime = Date.now();
        }
    }
    keyup(ev) {
        if(this.keys[ev.code]) {
            this.actions[this.keys[ev.code]] = false;
            if(this.keys[ev.code] == "j" && this.player) {
                this.player.jumpReleased = true;
            }
        }
    }
    run() {
        this.lastUpdate = Date.now();
        this.requestFrame();
        audio.play();
        this.musicPlaying = true;
    }
    requestFrame() {
        requestAnimationFrame(() => {this.updateAndRender()});
    }
    updateAndRender() {
        let now = Date.now();
        let delta = (now - this.lastUpdate)/1000;
        this.lastUpdate = now;
        this.objs.forEach(o => o.update(delta));
        this.objs = this.objs.filter(o=>o.ttl > 0);
        this.ctx.fillStyle = '#0e71b4';
        this.ctx.fillRect(0, 0, this.width, this.height);
        this.objs.forEach(o => o.render(this.ctx));
        if(!this.speedRunTime) {
            let runTime = (now - (this.startTime ? this.startTime : now)) / 1000.0;
            let elapsedTime = this.getTimeFormated(runTime);
            this.ctx.textAlign = "center";
            this.ctx.font = "24px serif";
            this.ctx.fillStyle = '#ffffff';
            this.ctx.fillText(elapsedTime,750,24);
        }
        this.requestFrame();
    }
    getTimeFormated(runTime) {
        runTime = runTime || 0;
        let minutes = Math.floor(runTime / 60.0);
        let seconds = Math.floor(runTime - minutes * 60.0);
        let tenth = Math.floor((runTime - minutes * 60.0 - seconds) * 10);
        return ("0" + minutes).substr(-2) + ":" + ("0" + seconds).substr(-2) + "." + tenth;
    }
    getColliderObjs(collGroup) {
        return this.objs.filter(o=>o.collGroup == collGroup);
    }
    addObj(obj) {
        this.objs.push(obj);
        obj.game = this;
        return obj;
    }
    removeObj(objToRemove) {
        this.objs = this.objs.filter(o => o !== objToRemove);
    }
}
class Vec {
    constructor(x,y) {
        this.x = x;
        this.y = y;
    }
    clone() {
        return new Vec(this.x, this.y);
    }
    multi(multi) {
        return new Vec(this.x * multi, this.y * multi);
    }
    plus(other) {
        return new Vec(this.x + other.x, this.y + other.y);
    }
    add(x,y) {
        this.x += x || 0;
        this.y += y || 0;
        return this;
    }
}
class Obj {
    constructor({pos, size, origin, ttl}) {
        this.pos = pos || new Vec(0,0);
        this.size = size || new Vec(0,0);
        this.origin = origin || new Vec(0.5,0.5);;
        this.type = "obj";
        this.collGroup = "";
        this.fillColor = color.floorBg;
        this.strokeColor = color.floorOl;
        this.game = null;
        this.ttl = ttl || Infinity;
    }
    render(ctx) {
        this.renderStart(ctx);
        ctx.fillStyle = this.fillColor;
        ctx.strokeStyle = this.strokeColor;
        if(this.fillColor) {
            ctx.fillRect(-this.size.x * this.origin.x, -this.size.y * this.origin.y, this.size.x, this.size.y);
        }
        if(this.strokeColor) {
            ctx.beginPath();
            ctx.rect(-this.size.x * this.origin.x, -this.size.y * this.origin.y, this.size.x, this.size.y);
            ctx.stroke();
        }
        this.renderPostProcess(ctx);
        ctx.restore();
    }
    renderStart(ctx) {
        ctx.save();
        ctx.translate(this.pos.x, this.pos.y);
    }
    renderPostProcess(ctx) {}
    update(delta) {
        this.ttl -= delta;
    }
}
class Dust extends Obj {
    constructor(obj) {
        let ttl = obj.ttl || 0.5;
        let shrinkrate = obj.size / ttl;
        let dx = obj.dx || 80;
        let dy = obj.dy || 80;
        let dxd = obj.dxd || dx/2;
        let dyd = obj.dyd || dy/2;
        obj.size = new Vec(obj.size, obj.size);
        super(obj);
        this.dPos = new Vec(Math.random() * dx - dxd, Math.random() * dy - dyd);
        this.fillColor = "#aaaaaa";
        this.strokeColor = null;
        this.ttl = ttl;
        this.shrinkrate = shrinkrate;
    }
    update(delta) {
        super.update(delta);
        this.size.x -=  this.shrinkrate * delta;
        this.size.y -=  this.shrinkrate * delta;
        this.pos.add(this.dPos.x * delta, this.dPos.y * delta);
    }
}
class LevelBlender extends Obj {
    constructor({game, rate, radius, target, finishedCallback}) {
        super({});
        this.game = game;
        this.target = target || this.game.player;
        this.rate = rate || game.canvas.width / 2;
        this.radius = radius || game.canvas.width;
        this.finishedCallback = finishedCallback || null;
    }
    update(delta) {
        this.radius -= this.rate * delta;
        if(this.radius < 0.1) {
            this.radius = 0.1;
            if(this.finishedCallback) {
                this.finishedCallback(this);
            }
            this.ttl = -1;
        }
        if(this.radius > this.game.canvas.width) {
            this.radius = this.game.canvas.width;
            if(this.finishedCallback) {
                this.finishedCallback(this);
            }
            this.ttl = -1;
        }
    }
    render(ctx) {
        ctx.beginPath();
        ctx.fillStyle = "#000000";
        ctx.rect(this.game.canvas.width, 0, -this.game.canvas.width, this.game.canvas.height);
        ctx.arc(this.target.pos.x, this.target.pos.y, this.radius, 0, 2*Math.PI);
        ctx.fill();
    }

}
class Floor extends Obj {
    constructor(obj) {
        obj.origin = new Vec(0, 0);
        super(obj);
        this.type = "floor";
        this.collGroup = "level";
        this.fillColor = "#8d6b6b";
        this.strokeColor = "#848691";
        this.brickFillColor = "#c16c45";
        this.brickStrokeColor = "#682417";
        this.bricks = [];
        let x = 0;
        while(x < this.size.x) {
            let w = Math.ceil(Math.random() * 15) + 5;
            if(x + w > this.size.x) {
                w = this.size.x - x;
            }
            let h = Math.ceil(Math.random() * 5) + 3;
            let y = Math.floor(Math.random() * 2);
            this.bricks.push({
                x: x,
                y: y,
                w: w,
                h: h
            });
            x += w;
        }
        let y = 0;
        while(y < this.size.y) {
            let h = Math.ceil(Math.random() * 15) + 5;
            if(y + h > this.size.y) {
                h = this.size.y - y;
            }
            let w = Math.ceil(Math.random() * 5) + 3;
            let x = Math.floor(Math.random() * 2);
            this.bricks.push({
                x: x,
                y: y,
                w: w,
                h: h
            });
            y += h;
        }
        y = 0;
        while(y < this.size.y) {
            let h = Math.ceil(Math.random() * 15) + 5;
            if(y + h > this.size.y) {
                h = this.size.y - y;
            }
            let w = Math.ceil(Math.random() * 5) + 3;
            let x = Math.floor(Math.random() * 2);
            this.bricks.push({
                x: this.size.x - x - w,
                y: y,
                w: w,
                h: h
            });
            y += h;
        }
    }
    renderPostProcess(ctx) {
        this.bricks.forEach(b => {
            ctx.fillStyle = this.brickFillColor;
            ctx.strokeStyle = this.brickStrokeColor;
            ctx.fillRect(b.x , b.y, b.w, b.h);
            ctx.beginPath();
            ctx.rect(b.x , b.y, b.w, b.h);
            ctx.stroke();
        });
    }
}

class Spikes extends Obj {
    constructor(obj) {
        obj.origin = new Vec(0, 0);
        super(obj);
        this.directionUp = obj.directionUp !== false;
        this.type = "spikes";
        this.collGroup = "level";
        this.fillColor = "#aaaaaa";
        this.strokeColor = "#dddddd";
    }
    render(ctx) {
        this.renderStart(ctx);
        let y1 = this.size.y;
        let y2 = 0;
        if(this.directionUp) {
            y1 = 0;
            y2 = this.size.y;
        }
        ctx.strokeStyle = this.strokeColor;
        ctx.fillStyle = this.fillColor;
        ctx.beginPath();
        ctx.moveTo(0,y2);
        let steps = Math.ceil(this.size.x / 10);
        let stepsize = this.size.x / steps;
        for(let x = 0; x <= this.size.x - stepsize +0.1; x+=stepsize) {
            ctx.lineTo(x+stepsize/2,y1);
            ctx.lineTo(x+stepsize, y2);
        }
        ctx.fill();
        ctx.stroke();
        ctx.restore();
    }
}

class Door extends Obj {
    constructor(obj) {
        obj.origin = new Vec(0, 0);
        super(obj);
        this.type = "door";
        this.collGroup = "level";
        this.fillColor = color.doorBg;
        this.strokeColor = color.doorOl;
        this.lock = obj.lock || 'allLocks';
        this.unlocked = false;
    }
    update(delta) {
        if(this.unlocked && this.size.y > 0) {
            this.size.y -= delta * 40;
            this.pos.y += delta * 40;
        }
    }
}

class Jumppad extends Obj {
    constructor(obj) {
        obj.origin = new Vec(0, 0);
        super(obj);
        this.jumpforce = obj.jumpforce || 3;
        this.type = "jumppad";
        this.collGroup = "level";
        this.fillColor = color.jumpBg;
        this.strokeColor = color.jumpOl;
    }
}

class Key extends Obj {
    constructor(obj) {
        obj.origin = new Vec(0.5, 0.5);
        obj.size = new Vec(20,20);
        super(obj);
        this.unlocking = obj.unlocking || 'allLocks';
        this.type = "key";
        this.collGroup = "keys";
        let defs = [
            ['#ffff88', null, -5,0, -8,3, -8,6, -11,6, -11,3, -14,-1, -14,-3, -11,-5, -8,-5, -5,-3, 8,-3, 8,-2, 7,-2, 7,1, 5,1, 5,-1, -5,-1, 'c'],
            [null, '#000000', -13,-2, -11,-2, -11,1],
            [null, '#000000', -6,-2, -8,-2, -8,1],
        ];
        this.currentPath = createPath(defs);
    }
    render(ctx) {
        ctx.save();
        ctx.translate(this.pos.x, this.pos.y);
        renderPaths(ctx, this.currentPath);
        ctx.restore();
    }
}
class Hourglass extends Obj {
    constructor(obj) {
        obj.origin = new Vec(0.5, 0.5);
        obj.size = new Vec(20,20);
        super(obj);
        this.type = "hourglass";
        this.collGroup = "collect";
        this.fillColor = '#ffffdd';
        this.textFillColor = '#ffffdd';
        this.strokeColor = '#ffff00';
        this.startTime = obj.startTime || Infinity;
        this.time = this.startTime;
		let defs = [
            [null, '#000000', -3,-8, 3,-8],
            [null, '#000000', -3,-8, -4,-6, -7,0],
			[null, '#000000', 3,-8, 4,-6, 7,0],
			['#000000','#000000', -7,0, -5,0, -5,3, -7,0],
			['#000000','#000000',  7,0, 5,0, 5,3, 7,0],
        ];
        /*let defs = [
            [color.cloakBg,color.cloakOl, -5,-10, 0,0, -5,10, 5,10, 0,0, 5,-10, 'c'],
            [color.bone, null, -3,-5, 0,0, 3,-5, 'c'],
            [color.bone, null, -4,9, 0,7, 4,9, 'c'],
            [null, '#aa8822', -7,-10, 7,-10],
            [null, '#aa8822', -7,10, 7,10],
            [null, '#aa8822', -5,-9, -5,9],
            [null, '#aa8822', 5,-9, 5,9],
        ];*/
        this.currentPath = createPath(defs);
    }
    update(delta) {
        if(this.time < -0.9) {
            this.game.player.stopUpdates = true;
            this.game.addObj(new LevelBlender({
                target:this,
                game:game,
                radius:game.canvas.width,
                rate:game.canvas.width/2,
                finishedCallback:(blendObj)=>{
                    game.removeObj(blendObj);
                    this.game.loadCurrentLevel();
                }
            }));
        } else {
            this.time -= delta;
        }
    }
    render(ctx) {
        ctx.save();
        ctx.translate(this.pos.x, this.pos.y);
        renderPaths(ctx, this.currentPath);
        if(this.time < Infinity) {
            ctx.textAlign = "center";
            if(this.time <= 0) {
                ctx.font = "24px serif";
                ctx.fillStyle = 'red';
            } else {
                ctx.font = "12px serif";
                ctx.fillStyle = this.textFillColor;
            }
            ctx.fillText(Math.ceil(this.time), 0, -15);
        }
        ctx.restore();
    }
}
class Text extends Obj {
    constructor(obj) {
        super(obj);
        this.type = "text";
        this.collGroup = "text";
        this.textFillColor = '#000000';
        this.text = obj.text || "";
        this.textsize = obj.textsize || "12";
        this.startTime = obj.startTime || Infinity;
        this.time = this.startTime;
    }
    update(delta) {
        this.time -= delta;
        if(this.time < -0.5) {
            this.game.removeObj(this);
        }
    }
    render(ctx) {
        this.renderStart(ctx);
        ctx.textAlign = "center";
        ctx.font = this.textsize + "px serif";
        ctx.fillStyle = this.textFillColor;
        ctx.fillText(this.text, 0, 0);
        ctx.restore();
    }
}
let createPath = (defs, flipX) => {
    let fX = flipX ? -1 : 1;
    return defs.map(d=> {
        let p = {
            fill:d[0],
            stroke:d[1],
            path: new Path2D()
        };
        p.path.moveTo(d[2] * fX, d[3]);
        for(let i = 4; i <= d.length -2; i+=2) {
            p.path.lineTo(d[i] * fX, d[i+1]);
        }
        if(d[d.length-1] == 'c') {
            p.path.closePath();
        }
        return p;
    });
}
let renderPaths = (ctx, paths) => {
    paths.forEach(p=> {
        if(p.fill) {
            ctx.fillStyle = p.fill;
            ctx.fill(p.path);
        }
        if(p.stroke) {
            ctx.strokeStyle = p.stroke;
            ctx.stroke(p.path); 
        }   
    });
}
class Player extends Obj {
    constructor(obj) {
        obj.size = new Vec(10,30);
        obj.origin = new Vec(0.5, 1);
        super(obj);
        this.respawnPos = this.pos.clone();
        this.type = "player";
        this.collGroup = "player";
        this.dPos = new Vec(0,0);
        this.speed = 100; // pixel per second
        this.dashFactor = 3;
        this.dashDuration = 0.25;
        this.dashtimer = this.dashDuration;
        this.jumpForce = 200;
        this.jumpReleased = true;
        this.gravity = 500;
        this.maxFallSpeed = 300;
        this.grounded = false;
        this.groundedTo = null;
        this.stopUpdates = false;
        this.stopRendering = false;
        this.walkDustTimout = 0.1;
        this.lastWalkDust = 0;
        let defs = [
			["#73ad0e","#73ad0e", -3,-45, 0,-50, 3,-45, 0,-40], //sim     
			["#e3c38e", null, -2,-25 ,-2,-35, 0,-37, 3,-37, 6,-35, 6,-30, 5,-28], //cabeza
			["#9c9d72","#9c9d72", -3,-1, -3,-15, 4,-15, 3,-1, 'c'], //pantalรณn
			["#35363a","#35363a", -3,-15, -1,-27, 2,-26, 5,-15, 1,-15, 1,-13, 0,-13, 0,-15, 'c'], //camisa
			["#7d3f28","#7d3f28", -3,0, -3,-1, 5,-1, 5,0, 'c'], //zapato            
            ['#ffffff', null, 3,-33, 5,-33, 5,-30, 3,-30], //ojo
			['black', null, 4,-32, 5,-32, 5,-31, 4,-31], //pupila
            ["#e3c38e", null, -1,-11, -1,-12, 1,-12, 1,-11], //mano
        ];
		/*
		let defs = [
            ["#7d92a9","#7d92a9", -8,0, -3,-15, -2,-27, 5,-20, 5,0, 'c'], //traje
            ["#e3c38e", null, -2,-30, 0,-32, 3,-32, 6,-30, 6,-20, 2,-21, -2,-24], //cabeza
			["#7d92a9", null, -3,-28, -6,-40, -8,-50, -6,-55, 6,-30, 10,-32, 6,-32], //sombrero
			["white", null, -2,-32, -4,-18, -3,-28, 6,-23, 6,1], //barba
            ['#ffffff', null, 3,-28, 5,-28, 5,-26, 3,-26], //ceja
			['black', null, 4,-28, 4,-27, 5,-26, 3,-26], //ojo
            [null, '#c7b081', 5,0, 10,-35], //baston
            ["#e3c38e", null, -1,-7, -1,-9, 1,-9, 1,-7], //mano
			["#e3c38e", null, 6,-17, 7,-17, 7,-16, 6,-16], //mano
        ];
		*/
        this.paths = {
            r: createPath(defs),
            l: createPath(defs, true)
        };
        defs.push([null, color.bone, -8,-7, -20,-7]);
        defs.push([null, color.bone, -8,-14, -25,-14]);
        defs.push([null, color.bone, -6,-20, -22,-20]);
        this.paths.dr = createPath(defs);
        this.paths.dl = createPath(defs, true);
        
        this.currentPath = this.paths.r;
    }
    update(delta) {
        if(this.stopUpdates) {
            return;
        }
        let walking = this.grounded;
        if(game.actions.l) {
            this.dPos.x = -this.speed;
            this.currentPath = this.paths.l;
        } else if(game.actions.r) {
            this.dPos.x = this.speed;
            this.currentPath = this.paths.r;
        } else {
            this.dPos.x *= 0.2;
            walking = false;
            this.lastWalkDust = 0;
        }
        if(walking) {
            this.lastWalkDust -= delta;
            if(this.lastWalkDust < 0) {
                this.createWalkDust();
                this.lastWalkDust = this.walkDustTimout;
            }
        }
 
        if(this.grounded) { 
            if(this.groundedTo && this.groundedTo.type == "jumppad") {
                this.dPos.y = -this.jumpForce * (this.groundedTo.jumpforce);
            } else if(game.actions.j && this.jumpReleased) {
                this.jumpReleased = false;
                this.dPos.y = -this.jumpForce;
                this.dashtimer = this.dashDuration;
                this.createJumpDust();
            } else {
                this.dPos.y = 0;
            }
        } else {
            if(game.actions.j && this.dPos.y <0) {
                this.dPos.y += this.gravity * 0.5 * delta;
            } else {
                this.dPos.y += this.gravity * delta;
            }
            if(game.actions.d && this.dashtimer > 0) {
                this.dashtimer -= delta;
                if(game.actions.l) {
                    this.dPos.x = -this.speed * this.dashFactor;
                    this.currentPath = this.paths.dl;
                }
                if(game.actions.r) {
                    this.dPos.x = this.speed * this.dashFactor;
                    this.currentPath = this.paths.dr;
                }
            }
        }
        if(this.dPos.y > this.maxFallSpeed) {
            this.dPos.y = this.maxFallSpeed;
        }

        this.pos = this.pos.plus(this.dPos.multi(delta));

        // Collisions
        this.grounded = false;
        let br = this.pos.clone().add(6,0);
        let bl = this.pos.clone().add(-6,0);
        let tl = bl.clone().add(0,-29);
        let tr = br.clone().add(0,-29);
        let t = this.pos.clone().add(0,-29);
        let r = this.pos.clone().add(7,-15);
        let l = this.pos.clone().add(-7,-15);

        let deadlyContact = false;
        game.getColliderObjs("level").forEach(o=> {
            let deadlyObject = ['spikes'].indexOf(o.type) >= 0;
            let otl = o.pos.clone().add(
                -o.size.x * o.origin.x,
                -o.size.y * o.origin.y,
            );
            let obr = o.pos.clone().add(
                o.size.x * (1 - o.origin.x),
                o.size.y * (1 - o.origin.y),
            );
            // jump - head
            if(this.dPos.y < 0 && t.y >= otl.y && t.y <= obr.y && t.x >= otl.x && t.x <= obr.x) {
                this.dPos.y = 0;
                this.pos.y = obr.y + 28;
                deadlyContact |= deadlyObject;
            }

            // right
            if(this.dPos.x > 0 && r.y >= otl.y && r.y <= obr.y && r.x >= otl.x && r.x <= obr.x) {
                this.dPos.x = 0;
                this.pos.x = otl.x -8;
                br = this.pos.clone().add(6,0);
                bl = this.pos.clone().add(-6,0);
                deadlyContact |= deadlyObject;
            }

            // left
            if(this.dPos.x < 0 && l.y >= otl.y && l.y <= obr.y && l.x >= otl.x && l.x <= obr.x) {
                this.dPos.x = 0;
                this.pos.x = obr.x +8;
                br = this.pos.clone().add(6,0);
                bl = this.pos.clone().add(-6,0);
                deadlyContact |= deadlyObject;
            }

            // bottom
            if(
                (br.y >= otl.y && br.y <= obr.y && br.x >= otl.x && br.x <= obr.x)
                || (bl.y >= otl.y && bl.y <= obr.y && bl.x >= otl.x && bl.x <= obr.x)
            ) {
                this.grounded = true;
                if(!this.groundedTo || this.groundedTo.type != "jumppad")
                this.groundedTo = o;
                this.pos.y = otl.y;
                deadlyContact |= deadlyObject;
            }
            
        });
        if(!this.grounded) {
            this.groundedTo = null;
        }
        game.getColliderObjs("collect").forEach(o=> {
            if (
                tl.x < o.pos.x + o.size.x * (1-o.origin.x) &&
                tr.x > o.pos.x - o.size.x * (1-o.origin.x) &&
                tl.y < o.pos.y + o.size.y * o.origin.y &&
                bl.y > o.pos.y - o.size.y * o.origin.y
            ) {
                this.game.removeObj(o);
            }
        });
        game.getColliderObjs("keys").forEach(o=> {
            if (
                tl.x < o.pos.x + o.size.x * (1-o.origin.x) &&
                tr.x > o.pos.x - o.size.x * (1-o.origin.x) &&
                tl.y < o.pos.y + o.size.y * o.origin.y &&
                bl.y > o.pos.y - o.size.y * o.origin.y
            ) {
                game.getColliderObjs("level").forEach(d=> {
                    if(d.lock == o.unlocking) {
                        d.unlocked = true;
                    }
                })
                console.log(o.unlocking);
                this.game.removeObj(o);
            }
        });
        if(game.getColliderObjs("collect").length == 0) {
            game.finishedCurrentLevel();
        }
        
        if(this.pos.y > this.game.canvas.height || deadlyContact) {
            this.dPos.x = 0;
            this.dPos.y = 0;
            this.createDeathDust(10);
            this.stopUpdates = true;
            this.stopRendering = true;
            let player = this;
            setTimeout(()=> player.respawn(), 1000);
        }
    }
    respawn() {
        this.stopUpdates = false;
        this.stopRendering = false;
        this.pos = this.respawnPos.clone();
        this.createDeathDust(15);
    }
    createDeathDust(amount) {
        for(let i = 0; i < (amount || 10); i++) {
            let dustPos = new Vec(this.pos.x + Math.random() * 20 - 10, this.pos.y - 14 + Math.random() * 30 - 15);
            this.game.addObj(new Dust({
                pos:dustPos, 
                size:Math.random() * 8 + 5, 
                ttl:Math.random() * 0.8 + 0.5
            }))
        }
    }
    createWalkDust() {
        this.game.addObj(new Dust({
            pos:this.pos.clone(), 
            size:2, 
            ttl:Math.random() * 0.4 + 0.2,
            dx:80, dy:40,
            dyd:40
        }));
    }
    createJumpDust() {
        for(let i = 0; i < 5; i++) {
            this.game.addObj(new Dust({
                pos:this.pos.clone(), 
                size:4, 
                ttl:Math.random() * 0.4 + 0.2,
                dx:80, dy:20,
                dxd:40, dyd:20
            }));
        }
    }
    render(ctx) {
        if(this.stopRendering) {
            return;
        }
        ctx.save();
        ctx.translate(this.pos.x, this.pos.y);
        renderPaths(ctx, this.currentPath);
        ctx.restore();
    }
}

const levelData = `
f~71~103~35~400ยงf~0~592~695~53ยงf~758~594~43~6ยงd~86~503~5~76~allLocksยงf~636~128~35~455ยงf~172~575~24~8ยงf~187~571~18~12ยงf~203~565~19~17ยงf~221~557~18~25ยงf~252~542~79~39ยงs~334~570~42~10~1ยงf~240~477~18~11ยงf~227~472~22~12ยงf~212~466~30~13ยงf~207~460~27~14ยงf~197~453~28~16ยงf~244~386~17~12ยงf~250~381~21~13ยงf~238~390~20~11ยงf~258~376~23~15ยงf~266~370~22~16ยงf~275~365~24~18ยงf~377~359~13~222ยงf~282~360~60~13ยงf~246~483~19~11ยงf~254~488~18~10ยงf~66~581~606~11ยงf~1413~153~14~139ยงf~329~359~13~137ยงf~236~548~17~34ยงf~173~365~25~103ยงf~106~364~93~19ยงf~379~360~257~14ยงk~56~561~allLocksยงp~20~114ยงt~363~74~JC ADVENTURE~0~50ยงf~411~266~207~21ยงf~516~197~98~15ยงf~562~133~55~15ยงh~653~112~0
#
p~12~112ยงh~784~402~0ยงh~49~473~0ยงf~-36~135~66~366ยงf~1~497~236~36ยงf~89~493~146~9ยงf~142~488~92~9ยงf~192~483~43~9ยงf~232~483~89~50ยงf~374~481~268~50ยงf~613~472~30~11ยงf~627~465~18~11ยงf~638~458~19~11ยงf~648~453~20~10ยงf~658~442~23~12ยงf~670~436~21~11ยงf~686~427~17~12ยงf~702~418~100~113ยงf~753~0~14~359ยงd~756~358~5~59~allLocksยงk~723~404~allLocksยงf~640~468~72~65ยงf~658~453~60~27ยงf~682~438~31~22ยงf~1~529~320~108ยงf~376~521~423~131ยงt~343~361~Cuidado con el agujero de la obra~0~12ยงt~530~382~Antes era Negro~0~12ยงf~158~34~24~352ยงf~546~48~21~306ยงf~176~116~377~16ยงf~173~211~383~20ยงf~178~294~374~18ยงt~538~31~MYCAMP~0~15ยงt~90~22~Vamos a tomar Cafรฉ~0~20ยงf~163~35~404~29ยงj~383~476~180~5~1.2
#
f~-2~94~450~15ยงf~568~92~233~16ยงf~438~105~16~9ยงf~448~110~15~9ยงf~455~118~17~6ยงf~462~120~16~8ยงf~468~127~17~8ยงf~475~133~17~9ยงf~483~141~17~7ยงf~491~147~18~8ยงf~500~153~21~10ยงf~511~160~19~9ยงf~569~105~15~20ยงf~520~166~207~11ยงf~781~164~20~13ยงf~774~171~13~10ยงf~768~176~12~10ยงf~764~181~10~7ยงf~758~183~10~11ยงf~754~191~10~7ยงf~748~195~11~6ยงf~745~197~7~9ยงf~737~200~11~9ยงf~732~206~12~8ยงf~727~211~10~8ยงf~724~218~11~6ยงf~716~220~11~7ยงf~709~223~11~8ยงf~701~226~10~8ยงf~694~232~11~7ยงf~681~237~17~8ยงf~677~240~11~9ยงf~670~246~11~9ยงf~664~252~11~8ยงf~597~257~68~8ยงf~585~259~14~9ยงf~579~263~10~8ยงf~571~268~11~8ยงf~563~275~13~7ยงf~559~280~11~7ยงf~553~284~10~8ยงf~543~290~14~8ยงf~535~295~14~6ยงf~530~299~11~10ยงf~525~307~12~7ยงf~519~310~10~7ยงf~512~313~9~9ยงf~506~318~10~7ยงf~502~323~10~7ยงf~498~327~9~6ยงf~491~329~8~8ยงf~486~335~11~6ยงf~476~340~13~7ยงf~471~342~9~8ยงf~465~346~9~10ยงf~459~351~10~11ยงf~449~354~13~12ยงf~444~362~12~9ยงf~437~367~12~8ยงf~430~371~10~8ยงf~421~376~11~8ยงf~415~381~9~8ยงf~407~386~9~7ยงf~400~388~10~8ยงf~331~388~69~9ยงf~-4~476~203~129ยงf~196~520~223~86ยงf~217~515~9~4ยงf~267~516~11~5ยงf~320~514~11~4ยงf~372~515~11~5ยงf~419~478~381~122ยงf~539~310~261~169ยงf~542~297~258~14ยงf~593~261~206~38ยงf~732~218~68~45ยงf~767~187~31~33ยงf~413~173~107~69ยงf~332~219~111~79ยงf~412~225~65~38ยงf~-3~286~363~26ยงf~2~105~354~185ยงf~348~107~88~114ยงf~425~109~27~71ยงf~448~116~16~60ยงf~459~121~9~55ยงf~463~131~17~45ยงf~475~137~11~38ยงf~484~144~11~31ยงf~495~151~9~25ยงf~500~156~13~20ยงf~508~161~12~15ยงf~498~173~58~35ยงf~553~171~48~13ยงf~467~345~130~10ยงf~412~387~171~8ยงf~482~352~106~40ยงf~514~318~52~30ยงf~571~274~33~28ยงf~690~239~52~28ยงf~717~226~26~16ยงf~744~203~29~20ยงf~787~173~13~48ยงf~697~383~72~123ยงf~631~456~73~58ยงf~-1~307~81~193ยงf~444~369~46~20ยงf~466~353~25~18ยงf~431~379~14~9ยงf~499~332~20~14ยงf~564~288~10~10ยงf~676~247~22~16ยงf~709~232~14~10ยงf~687~233~7~5ยงs~655~248~8~9~1ยงs~401~376~9~13~1ยงs~199~508~15~12~1ยงs~228~507~36~15~1ยงs~281~505~36~15~1ยงs~332~504~38~16~1ยงs~385~506~32~14~1ยงt~571~45~<Begoรฑa>~0~20ยงf~573~54~8~40ยงt~707~125~Cuidado con las escaleras mecรกnicas~0~12ยงt~233~351~Ahora hay que llegar al andรฉn~0~12ยงp~17~82ยงh~468~456~0ยงt~178~418~Mierda! Me he equivocado de andรฉn~0~12ยงh~130~452~0
#
f~42~93~97~36ยงf~227~1~24~468ยงf~67~562~98~37ยงf~226~560~23~26ยงf~339~557~100~33ยงf~502~494~100~25ยงf~345~419~87~28ยงf~506~350~75~33ยงf~387~292~41~33ยงf~511~236~52~28ยงf~389~165~42~29ยงf~511~109~104~24ยงf~646~95~27~530ยงf~552~105~95~5ยงf~573~100~75~5ยงf~599~95~50~5ยงf~620~89~86~7ยงf~723~552~28~64ยงf~705~543~63~9ยงp~92~33ยงh~734~510~0ยงh~295~502~0ยงh~522~89~0ยงt~409~29~Some more todos, young apprentice...~0~18ยงt~354~48~Go, get 'em all! Quick!~0~12
#
f~687~271~33~115ยงf~93~271~32~114ยงf~92~383~628~29ยงf~92~264~628~7ยงp~154~301ยงh~640~354~15ยงt~253~207~I recently mentioned the word "quick"...~0~18ยงt~373~225~...some hourglasses have only a few seconds left...~0~14ยงt~512~240~... so you got to hurry up!~0~12ยงt~551~440~As soon as one hourglass reaches zero, your lesson will restart.~0~12ยงt~621~462~An apprenticeship is no piece of cake, after all.~0~12
#
f~289~298~210~131ยงf~321~494~145~60ยงf~465~536~211~18ยงf~102~537~219~17ยงf~675~104~19~450ยงf~84~99~610~5ยงf~82~100~21~456ยงf~578~246~47~23ยงf~103~305~42~20ยงf~120~354~61~20ยงf~198~467~47~19ยงf~150~410~64~20ยงf~184~257~47~20ยงf~637~307~39~20ยงf~605~366~45~20ยงf~570~425~42~23ยงf~537~475~40~17ยงp~388~256ยงh~602~219~22ยงh~198~228~17ยงh~129~506~32ยงh~639~504~6ยงt~384~57~It's time for a little test, my apprentice!~0~18ยงt~385~80~You'll have to choose the order in which you should collect the hourglasses.~0~12
#
f~166~329~28~275ยงf~488~329~30~270ยงf~90~310~167~19ยงf~437~308~168~21ยงp~115~281ยงh~586~286~0ยงt~204~77~Sometimes, when it looks too far...~0~18ยงt~462~90~... a little well timed SHIFT helps.~0~18ยงt~232~152~Jump while walking, aaaand...~0~12ยงt~417~166~.. press [SHIFT] for a little extra push.~0~12ยงf~76~229~14~99
#
h~595~398~0ยงf~123~429~585~20ยงp~284~392ยงj~389~424~44~5~1.7ยงj~677~424~30~5~2ยงf~538~301~117~14ยงh~178~399~0ยงt~261~83~An obstacle is to big for you to jump over it? ~0~18ยงt~377~116~When you are lucky, Death left a handy jumppad for you nearby.~0~14ยงt~467~145~Just walk onto it, and let the thing do its magic... weeee!eh!~0~12ยงt~310~473~Always remember: when you are stuck, just jump off a cliff. You'll respawn. ;-)~0~12ยงf~443~300~36~129ยงf~233~298~41~131
#
d~411~267~5~97~d1ยงk~471~535~d1ยงf~71~434~210~15ยงf~222~427~59~8ยงf~243~420~60~8ยงf~261~413~57~8ยงf~279~408~54~7ยงf~294~400~56~9ยงf~313~395~60~9ยงf~325~387~65~10ยงf~345~379~63~10ยงf~363~372~67~9ยงf~387~362~347~10ยงf~382~131~42~134ยงf~377~258~370~11ยงf~289~122~146~13ยงf~725~253~29~120ยงh~690~336~0ยงf~7~564~522~15ยงj~15~559~32~5~2ยงt~164~77~When your path is locked...~0~20ยงt~462~461~... the indirect way may turns out to be the "KEY" to success.~0~14ยงp~329~287
#
f~13~18~765~18ยงf~752~34~26~547ยงf~228~202~22~172ยงf~246~359~190~15ยงf~416~217~20~157ยงf~523~421~114~17ยงf~481~375~28~15ยงf~568~259~25~13ยงf~608~201~148~17ยงj~680~569~43~5~1.8ยงf~13~35~27~541ยงf~40~208~143~18ยงf~162~226~18~274ยงj~40~569~101~5~2.2ยงf~226~182~124~21ยงf~334~35~20~147ยงf~107~112~172~18ยงf~179~34~18~80ยงp~148~76ยงk~230~78~1ยงd~571~472~5~102~1ยงf~564~438~21~34ยงf~242~372~17~70ยงd~373~373~5~71~2ยงf~244~440~211~17ยงk~284~265~3ยงf~327~203~21~92ยงj~257~356~152~5~2ยงh~301~408~0ยงf~510~35~23~101ยงf~533~117~144~19ยงd~661~36~5~81~3ยงh~563~79~0ยงk~638~241~2ยงf~624~314~128~18ยงh~96~373~0ยงf~14~573~300~20ยงf~404~573~374~20ยงt~83~53~Jump around~0~14ยงf~538~318~86~14
#
s~224~453~124~45~1ยงs~410~454~262~81~1ยงf~212~495~153~30ยงf~403~528~279~20ยงf~348~449~62~101ยงf~673~450~91~104ยงf~38~447~185~86ยงf~466~390~36~16ยงf~555~357~38~19ยงh~733~426~0ยงp~64~412ยงt~234~119~Spikes in Death's domain ?!?!??~0~20ยงt~325~157~Well, yes. Why not?~0~16ยงt~394~187~Dont touch them.~0~12
#
s~155~552~244~49~1ยงs~160~381~250~45~0ยงf~29~548~127~53ยงf~510~394~54~55ยงf~152~361~263~30ยงf~397~548~94~56ยงf~248~519~59~17ยงj~445~543~37~5~2ยงs~431~176~45~21~1ยงs~521~176~38~19~1ยงs~605~173~38~22~1ยงh~726~165~0ยงd~364~92~5~104~allLocksยงk~588~343~allLocksยงj~200~357~31~5~1.7ยงp~55~517ยงs~289~209~410~60~0ยงf~283~193~482~26ยงf~34~15~342~83ยงt~186~50~Roses are red, Violets are blue.~0~18ยงt~221~70~A spike on the head, will also hurt you.~0~15
#
f~0~576~802~77ยงf~95~569~37~8ยงf~106~560~36~9ยงf~115~551~39~9ยงf~126~540~40~11ยงf~137~533~38~8ยงf~147~521~38~12ยงf~159~511~43~11ยงf~171~496~51~15ยงf~319~493~62~112ยงf~440~492~21~116ยงf~587~492~25~113ยงf~605~485~32~13ยงf~614~476~34~10ยงf~623~465~37~10ยงf~633~454~42~11ยงf~648~442~46~13ยงf~675~447~63~153ยงf~768~264~59~338ยงj~697~440~39~5~1.7ยงs~170~557~149~19~1ยงs~381~554~59~22~1ยงs~461~554~126~23~1ยงs~612~552~62~25~1ยงs~737~548~31~29~1ยงf~-4~263~692~97ยงs~641~240~47~23~1ยงf~120~125~694~66ยงs~522~241~61~22~1ยงs~195~191~288~17~0ยงd~633~190~5~74~3ยงd~676~359~5~84~2ยงd~120~190~5~74~4ยงf~-10~358~66~118ยงf~23~404~472~14ยงf~146~539~24~40ยงf~129~558~20~26ยงd~465~359~5~47~1ยงk~70~388~2ยงk~448~477~1ยงk~786~253~3ยงk~492~194~4ยงf~113~2~156~70ยงf~34~46~77~30ยงf~40~72~25~145ยงf~102~54~37~20ยงf~102~33~19~26ยงf~61~66~21~21ยงf~36~71~13~45ยงf~29~115~20~12ยงf~30~125~23~88ยงf~-5~-2~11~266ยงf~3~-13~280~23ยงf~193~8~22~44ยงk~103~21~5ยงd~257~72~5~55~5ยงj~12~259~33~5~1.7ยงh~726~43~0ยงs~682~99~118~27~1ยงf~280~2~231~33ยงf~277~0~134~21ยงf~406~1~132~46ยงf~398~-16~127~40ยงf~518~-3~65~22ยงf~317~62~64~104ยงf~42~417~51~20ยงf~48~435~30~17ยงf~91~417~51~10ยงf~489~416~5~6ยงf~404~416~13~8ยงf~336~414~18~9ยงf~286~416~29~7ยงf~161~416~94~6ยงf~320~526~30~77ยงf~432~583~15~25ยงf~604~582~18~21ยงf~731~582~19~20ยงf~785~334~16~75ยงf~21~318~40~49ยงf~53~298~265~43ยงf~307~322~108~37ยงf~600~287~83~53ยงf~580~315~47~34ยงf~485~143~85~35ยงf~556~135~47~23ยงf~591~151~30~20ยงf~717~147~92~25ยงf~708~156~29~23ยงf~297~144~41~33ยงf~361~156~28~17ยงf~128~146~58~28ยงf~170~161~45~22ยงf~203~127~37~37ยงf~236~135~45~21ยงf~256~148~46~30ยงf~456~14~30~17ยงf~373~10~42~20ยงf~707~511~28~90ยงf~344~519~16~30ยงp~19~551ยงs~755~191~46~17~0ยงf~185~180~300~6
#
f~14~570~60~16ยงf~116~500~70~13ยงf~357~574~23~11ยงf~422~538~27~10ยงf~466~484~38~11ยงf~521~438~37~10ยงf~465~388~39~13ยงf~527~328~44~12ยงf~473~259~16~10ยงf~527~197~20~10ยงf~565~195~42~12ยงf~615~90~44~11ยงf~670~559~46~11ยงf~741~343~47~14ยงf~709~283~17~10ยงf~698~47~11~305ยงf~747~230~39~11ยงf~147~69~136~10ยงj~159~495~26~5~1.7ยงj~571~191~36~5~1.7ยงf~648~90~12~421ยงj~696~554~20~5~1.7ยงj~749~225~35~5~1.7ยงf~187~251~133~262ยงp~34~33ยงh~151~59~0ยงk~380~232~1ยงf~401~177~10~310ยงf~436~212~13~11ยงs~75~571~278~28~1ยงs~384~575~284~24~1ยงs~719~580~80~19~1ยงf~777~520~15~12ยงk~778~509~2ยงd~648~51~5~40~1ยงf~532~41~177~10ยงf~533~46~12~55ยงf~282~92~263~18ยงf~475~0~24~58ยงf~134~0~13~79ยงf~147~0~329~14ยงf~499~-10~209~14ยงd~648~4~5~37~2ยงf~356~108~13~170ยงs~283~69~90~23~1
#
p~15~343ยงh~789~49~0ยงf~1~364~66~23ยงj~49~359~18~5~1.7ยงf~67~209~77~178ยงf~271~470~9~9ยงj~270~465~11~5~1.7ยงs~217~480~113~121~1ยงf~552~75~93~256ยงf~366~0~91~174ยงf~366~226~91~375ยงf~551~0~249~29ยงk~537~312~2ยงf~456~265~8~9ยงf~545~218~8~9ยงf~455~165~8~8ยงf~545~112~8~8ยงd~595~30~5~45~2ยงd~372~174~5~53~1ยงf~717~25~25~368ยงf~745~439~55~162ยงf~710~210~8~7ยงf~644~324~9~9ยงf~644~475~9~10ยงf~737~517~9~9ยงf~737~461~8~8ยงf~741~250~8~8ยงf~740~176~9~6ยงf~204~306~13~299ยงf~330~308~13~293ยงs~645~292~8~32~1ยงk~272~375~1ยงf~456~-6~94~15ยงs~456~9~94~18~0ยงs~0~386~144~24~0ยงk~649~457~3ยงd~745~381~5~57~4ยงf~742~368~10~12ยงf~789~61~11~42ยงf~789~105~13~336ยงj~768~433~20~5~2ยงf~456~385~90~54ยงf~524~439~22~26ยงf~532~465~14~32ยงf~457~439~12~32ยงf~546~332~97~182ยงf~542~556~10~44ยงf~531~562~10~40ยงf~523~567~8~35ยงf~513~572~10~31ยงf~504~576~9~27ยงf~457~583~49~27ยงk~466~571~4ยงd~628~515~5~35~3ยงf~0~459~142~157ยงs~0~424~141~35~1ยงf~552~551~95~60ยงs~647~566~97~34~1ยงs~457~342~89~44~1ยงf~691~323~27~11ยงs~692~297~26~25~1ยงf~554~307~87~57ยงf~605~354~36~49ยงf~87~198~57~11
#
f~0~202~67~400ยงf~713~197~90~410ยงf~107~202~15~7ยงf~91~202~14~8ยงf~69~202~20~8ยงf~654~196~17~6ยงf~694~197~18~7ยงf~673~197~19~6ยงf~247~404~19~196ยงf~480~404~19~196ยงf~207~386~104~18ยงf~446~380~87~24ยงf~208~327~13~59ยงf~300~355~11~30ยงf~222~360~17~25ยงf~446~243~16~136ยงf~520~296~13~83ยงf~463~348~14~31ยงf~501~344~13~35ยงf~508~314~12~29ยงf~253~371~42~14ยงf~282~356~17~14ยงp~18~182ยงh~772~177~0ยงt~415~197~You trust your powers...~0~25ยงf~694~205~18~8ยงf~696~215~16~8ยงf~678~204~14~9ยงf~69~212~20~12ยงf~69~225~13~13ยงf~91~212~22~8ยงj~910~736~208~5~5ยงf~0~-3~65~135ยงf~61~-4~77~90ยงf~133~-5~74~60ยงf~206~-5~81~48ยงf~273~28~9~30ยงf~234~31~6~29ยงf~247~29~5~19ยงf~204~37~3~20ยงf~195~37~5~29ยงf~282~-3~138~32ยงf~419~-5~8~47ยงf~426~-3~72~34ยงf~455~16~6~43ยงf~483~18~3~25ยงf~496~0~138~49ยงf~612~-6~103~77ยงf~711~-1~92~108ยงf~536~30~5~34ยงf~596~42~20~19ยงf~687~62~29~30ยงf~659~62~5~29ยงf~631~59~5~20ยงf~568~41~5~17ยงf~516~40~4~16ยงf~355~2~59~17ยงf~259~1~15~3ยงf~274~4~8~3ยงf~276~12~23~4ยงf~187~9~35~12ยงf~119~16~27~14ยงf~43~48~33~17ยงf~133~75~5~16ยงf~165~42~6~20ยงf~686~78~4~26ยงf~695~15~25~55ยงf~601~9~36~21ยงf~519~10~42~26ยงf~475~2~40~13ยงf~755~1~33~39ยงf~768~23~28~39ยงf~50~7~28~43ยงf~128~25~26~38ยงs~287~29~131~13~0ยงs~428~31~26~11~0ยงf~645~196~8~6ยงf~662~203~14~6ยงf~705~225~7~14ยงf~419~42~4~15ยงs~416~58~10~16~0ยงj~381~600~56~5~3.2
#
s~-11~566~822~37~1ยงf~286~469~215~23ยงj~472~464~28~5~1.7ยงj~286~464~29~5~1.7ยงf~628~412~32~22ยงf~128~412~28~17ยงj~629~407~29~5~1.7ยงj~127~407~30~5~1.7ยงf~356~207~55~43ยงf~331~159~112~50ยงf~329~111~18~53ยงf~382~116~13~46ยงf~431~110~12~49ยงf~339~95~97~21ยงf~361~135~10~11ยงf~409~139~11~8ยงt~386~53~That's the end, my apprentice!~0~32ยงt~384~295~You took {speedRunTime} to complete your training~0~18ยงt~385~325~(Your best time ever was {bestTime})~0~12ยงt~390~514~THX for playing! Hope you had fun~0~12ยงp~386~357ยงt~385~340~Press F5, if you want to try again...~0~12`;
const game = new Game(document.getElementById('canvas'), levelData.trim());
game.run();
game.loadNextLevel();
