<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Reproductor YouTube con Historial Detallado</title>
  <style>
    body {
      margin: 0; padding: 20px;
      background: #000; color: #fff;
      font-family: Arial, sans-serif;
      display: flex; flex-direction: column; align-items: center;
    }
    #load-url-container {
      margin-bottom: 20px; width: 80%; max-width: 800px;
    }
    #url-input {
      width: 85%; max-width: 658px; padding: 8px; font-size: 1rem;
    }
    #load-btn {
      padding: 8px 12px; font-size: 1rem; margin-left: 8px;
	  background: #0e71b4;
      cursor: pointer;
    }
    #video-container {
      position: relative;
      width: 80%; max-width: 800px; height: 450px;
      margin-top: 20px;
      overflow: hidden;
    }
    #video-placeholder {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
	  pointer-events: none;
    }
    #video-placeholder iframe {
      width: 100% !important;
      height: 100% !important;
    }
    #controls-container {
      position: absolute; bottom: 0; width: 100%;
      background: rgba(0,0,0,0.5);
      display: flex; flex-direction: column; gap: 10px;
      z-index: 3;
      transition: opacity 0.5s;
    }
    #video-container.hide-controls #controls-container { opacity: 0; }
    .buttons-container {
      display: flex; justify-content: space-between; align-items: center;
    }
    .left-controls, .right-controls {
      display: flex; align-items: center; gap: 10px;
    }
    button { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; }
    #progress-bar { width: 100%; }
    #mute-container { position: relative; display: inline-flex; align-items: center; }
    #volume-control { display: none; width: 80px; margin-left: 5px; }
    #mute-container:hover #volume-control { display: inline-block; }

    /* Historial */
    #history-container {
      margin-top: 30px;
      width: 80%; max-width: 800px;
      background: rgba(255,255,255,0.1);
      padding: 10px; border-radius: 8px;
    }
    #history-container h2 {
      margin: 0 0 10px; font-size: 1.2rem; color: #fff;
    }
    #history-list {
      list-style: none; padding: 0; margin: 0;
    }
    #history-list li {
      display: flex; justify-content: space-between; align-items: center;
      padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    #history-list li:last-child { border-bottom: none; }
    .history-item div {
      display: flex; gap: 10px;
    }
    .play-button {
      background: #0e71b4; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem;
      color: #fff; cursor: pointer;
    }
    .delete-button {
      background: #ff4d4d; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem;
      color: #fff; cursor: pointer;
    }
    .history-meta {
      font-size: 0.8rem; color: #ccc;
      margin-left: 8px;
    }
	
	/* 1) V√≠deo responsivo con aspect-ratio */
#video-container {
  position: relative;
  width: 100%;
  max-width: 800px;
  aspect-ratio: 16 / 9;
  margin: 20px 0;
  overflow: hidden;
  height: initial;
}

#video-placeholder {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
}

/* 2) Formulario adaptable */
#load-url-container {
  display: flex;
  width: 100%;
  max-width: 800px;
  gap: 8px;
}

#url-input {
  flex: 1;
  padding: 8px;
  font-size: 1rem;
}

#load-btn {
  padding: 8px 12px;
  font-size: 1rem;
  background: #0e71b4;
  border-radius: 4px;
}

/* 3) Historial ocupa todo el ancho */
#history-container {
  width: 100%;
  max-width: 800px;
  margin-top: 30px;
}

/* 4) Media queries para m√≥viles */
@media (max-width: 600px) {
  body {
    padding: 10px;
  }
  #load-url-container {
    flex-direction: column; margin-bottom: 0px;
  }
  #load-url-container input,
  #load-url-container button {
    width: 100%;
    padding: 4px 0;
	margin: initial;
  }
  #controls-container {
    padding: 0px;
  }
  .buttons-container button {
    font-size: 20px; padding-inline: 0px;
  }
  #time-display {
    font-size: 0.9rem;
  }
  .history-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
  .history-item div {
    width: 100%;
    justify-content: space-between;
  }
  #history-container {
    margin-top: 0px;
  }
  .play-button, .delete-button {
    font-size: 0.8rem;
    padding: 4px 6px;
  }
}

  </style>
</head>
<body>

  <div id="load-url-container">
    <input id="url-input" type="text" placeholder="https://youtu.be/VIDEO_ID" />
    <button id="load-btn">Cargar URL</button>
  </div>

  <div id="video-container" onmousemove="showControls()" onmouseleave="hideControls()" ontouchstart="showControls()">
    <div id="video-placeholder"></div>
    <div id="controls-container">
      <input id="progress-bar" type="range" min="0" max="100" value="0" step="0.1"
             oninput="seekVideo(this.value)" />
      <div class="buttons-container">
        <div class="left-controls">
          <button onclick="skipBackward()">‚è™</button>
          <button id="playPauseButton" onclick="togglePlayPause()">‚ñ∂Ô∏è</button>
          <button onclick="skipForward()">‚è©</button>
          <div id="mute-container">
            <button id="muteButton" onclick="toggleMute()">üîä</button>
            <input id="volume-control" type="range" min="0" max="100" value="50"
                   oninput="changeVolume(this.value)" />
          </div>
        </div>
        <div class="right-controls">
          <div id="time-display">0:00 / 0:00</div>
          <button onclick="toggleFullScreen()">‚õ∂</button>
        </div>
      </div>
    </div>
  </div>

  <div id="history-container">
    <h2>Historial de V√≠deos</h2>
    <ul id="history-list"></ul>
  </div>

  <script>
    let player, isMuted=false, isPlaying=false;
    let progressBar, timeDisplay, hideControlsTimeout;
    let saveInterval, playerReady=false;

    const historyKey = 'ytHistory';
    const raw = JSON.parse(localStorage.getItem(historyKey) || '{}');
    const historyData = {};
    // Migrar datos antiguos si hay (n√∫mero ‚ûî {time,title,lastPlayed})
    for (const [id,val] of Object.entries(raw)) {
      if (typeof val === 'object') {
        historyData[id] = {
          time: val.time||0,
          title: val.title||id,
          lastPlayed: val.lastPlayed||new Date().toISOString()
        };
      } else {
        historyData[id] = {
          time: val,
          title: id,
          lastPlayed: new Date().toISOString()
        };
      }
    }

    function saveHistory(){
      localStorage.setItem(historyKey, JSON.stringify(historyData));
    }

    function renderHistory(){
      const ul = document.getElementById('history-list');
      ul.innerHTML = '';
      // Ordenar por lastPlayed descendente
      const items = Object.entries(historyData)
        .sort((a,b) => new Date(b[1].lastPlayed) - new Date(a[1].lastPlayed));
      for (const [id,data] of items) {
        const m = Math.floor(data.time/60), s = Math.floor(data.time%60);
        const ts = `${m}:${s<10?'0':''}${s}`;
        // Fecha legible
        const fecha = new Date(data.lastPlayed)
                        .toLocaleString('es-ES', { dateStyle:'short', timeStyle:'short' });
        const li = document.createElement('li');
        li.className = 'history-item';
        li.innerHTML = `
          <div>
            <span><strong>${data.title}</strong> ‚Äî ${ts}</span>
            <span class="history-meta">${fecha}</span>
          </div>
          <div>
            <button class="play-button" data-id="${id}" data-time="${data.time}">
              Reproducir
            </button>
            <button class="delete-button" data-id="${id}">‚úñ</button>
          </div>
        `;
        li.querySelector('.play-button').onclick = e => {
          loadAndPlay(e.target.dataset.id, parseFloat(e.target.dataset.time));
        };
        li.querySelector('.delete-button').onclick = e => {
          delete historyData[e.target.dataset.id];
          saveHistory();
          renderHistory();
        };
        ul.appendChild(li);
      }
    }

    function updateProgressStorage(){
      if (player && player.getCurrentTime) {
        const id  = player.getVideoData().video_id;
        const cur = player.getCurrentTime();
        if (id) {
          historyData[id].time = cur;
          historyData[id].lastPlayed = new Date().toISOString();
          saveHistory();
          renderHistory();
        }
      }
    }

    function parseVideoID(url){
      const v = url.match(/[?&]v=([^&]+)/),
            s = url.match(/youtu\.be\/([^?&]+)/);
      return v ? v[1] : s ? s[1] : null;
    }

    function onYouTubeIframeAPIReady(){
      player = new YT.Player('video-placeholder', {
        videoId: '',
        playerVars: {
          autoplay:0, controls:0, rel:0,
          modestbranding:1, playsinline:1
        },
        events: {
          onReady: () => {
            playerReady = true;
            const iframe = player.getIframe();
            iframe.setAttribute(
              'allow',
              'autoplay; encrypted-media; accelerometer; gyroscope; picture-in-picture; clipboard-write; web-share'
            );
            progressBar = document.getElementById('progress-bar');
            timeDisplay = document.getElementById('time-display');
            updateProgressBar();
            renderHistory();
          },
          onStateChange: e => {
            clearInterval(saveInterval);
            if (e.data === YT.PlayerState.PLAYING) {
              isPlaying = true;
              saveInterval = setInterval(updateProgressStorage, 2000);
              hideControls();
            } else {
              isPlaying = false;
              showControls();
            }
            document.getElementById('playPauseButton')
                    .innerText = isPlaying?'‚è∏Ô∏è':'‚ñ∂Ô∏è';
          },
          onError: () => alert('Error al reproducir el v√≠deo.')
        }
      });
    }

	function loadAndPlay(id, start = 0) {
	  if (!playerReady) return setTimeout(() => loadAndPlay(id, start), 100);
	  player.loadVideoById({ videoId: id, startSeconds: start });
	  player.playVideo();

	  // Creo la entrada si no existe y actualizo lastPlayed
	  historyData[id] = historyData[id] || { time: start, title: id };
	  historyData[id].lastPlayed = new Date().toISOString();
	  saveHistory();
	  renderHistory();

	  // üöÄ Aqu√≠ pedimos el t√≠tulo real y volvemos a renderizar
	  fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${id}&format=json`)
		.then(res => res.json())
		.then(o => {
		  historyData[id].title = o.title;
		  saveHistory();
		  renderHistory();
		})
		.catch(_ => {/* si falla, dejamos el ID como t√≠tulo */});
	}

    document.getElementById('load-btn').onclick = () => {
      const url = document.getElementById('url-input').value.trim();
      const id  = parseVideoID(url);
      if (!id) return alert('URL no v√°lida');
      loadAndPlay(id, 0);
    };

    // Controles de reproducci√≥n
    function togglePlayPause(){
      if (!player) return;
      isPlaying ? player.pauseVideo() : player.playVideo();
    }
    function skipForward(){ player.seekTo(player.getCurrentTime()+30, true); }
    function skipBackward(){ player.seekTo(Math.max(player.getCurrentTime()-10,0), true); }
    function changeVolume(v){ player.setVolume(v); }
    function seekVideo(v){ player.seekTo((v/100)*player.getDuration(), true); }
    function toggleFullScreen(){
      const c = document.getElementById('video-container');
      document.fullscreenElement ? document.exitFullscreen() : c.requestFullscreen();
    }
    function showControls(){
      clearTimeout(hideControlsTimeout);
      document.getElementById('video-container').classList.remove('hide-controls');
      if (isPlaying) {
        hideControlsTimeout = setTimeout(() => {
          document.getElementById('video-container').classList.add('hide-controls');
        }, 2000);
      }
    }
    function hideControls(){
      if (isPlaying) {
        hideControlsTimeout = setTimeout(() => {
          document.getElementById('video-container').classList.add('hide-controls');
        }, 2000);
      }
    }

    function updateProgressBar(){
      setInterval(() => {
        if (player && typeof player.getDuration==='function') {
          const c = player.getCurrentTime(), d = player.getDuration();
          progressBar.value = (c/d)*100;
          timeDisplay.innerText = `${formatTime(c)} / ${formatTime(d)}`;
        }
      }, 500);
    }
    function formatTime(s){
      const m = Math.floor(s/60), sec = Math.floor(s%60);
      return `${m}:${sec<10?'0':''}${sec}`;
    }

    // Carga inicial de la API YouTube
    (function(){
      const tag = document.createElement('script');
      tag.src = 'https://www.youtube.com/iframe_api';
      document.head.appendChild(tag);
    })();
  </script>
</body>
</html>
