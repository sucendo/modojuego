<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oxford (2¬∫ Primaria) ‚Äî Tema 3: Things I can do</title>
  <style>
    :root{
      --bg1:#ffedd5;
      --bg2:#dbeafe;
      --bg3:#dcfce7;
      --ink:#0b1020;
      --muted:#334155;

      --panel:#ffffffcc;
      --card:#ffffffee;

      --a:#a78bfa;
      --b:#fb7185;
      --c:#22c55e;
      --d:#06b6d4;
      --e:#f59e0b;

      --shadow: 0 18px 40px rgba(2,6,23,.18);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(167,139,250,.35), transparent 62%),
        radial-gradient(820px 520px at 85% 25%, rgba(251,113,133,.28), transparent 60%),
        radial-gradient(900px 520px at 70% 85%, rgba(34,197,94,.22), transparent 58%),
        linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
    }
    .app{
      width:min(1020px, 100%);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      border:2px solid rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,.55);
    }
    header{
      padding:16px 18px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      background: linear-gradient(90deg, rgba(167,139,250,.25), rgba(251,113,133,.18), rgba(34,197,94,.18));
      border-bottom: 2px solid rgba(255,255,255,.7);
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .title h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .spark{
      display:inline-grid;
      place-items:center;
      width:26px;
      height:26px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(167,139,250,.8), rgba(251,113,133,.75));
      color:white;
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
    }
    .title small{ color: rgba(15,23,42,.75); }
    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    button, select, input{
      border-radius: 14px;
      border: 2px solid rgba(255,255,255,.9);
      background: rgba(255,255,255,.75);
      color: var(--ink);
      padding:10px 12px;
      font-size:14px;
      outline:none;
      box-shadow: 0 10px 18px rgba(2,6,23,.08);
    }
    select{ cursor:pointer; }
    button{
      cursor:pointer;
      transition: transform .05s ease, filter .2s ease;
      user-select:none;
      font-weight: 700;
    }
    button:hover{ filter: brightness(1.03) saturate(1.05); }
    button:active{ transform: translateY(1px); }

    .btn-a{ background: linear-gradient(135deg, rgba(167,139,250,.85), rgba(167,139,250,.45)); color: white; border-color: rgba(255,255,255,.95); }
    .btn-b{ background: linear-gradient(135deg, rgba(251,113,133,.85), rgba(251,113,133,.45)); color: white; border-color: rgba(255,255,255,.95); }
    .btn-c{ background: linear-gradient(135deg, rgba(34,197,94,.85), rgba(34,197,94,.42)); color: white; border-color: rgba(255,255,255,.95); }
    .btn-d{ background: linear-gradient(135deg, rgba(6,182,212,.85), rgba(6,182,212,.40)); color: white; border-color: rgba(255,255,255,.95); }
    .btn-e{ background: linear-gradient(135deg, rgba(245,158,11,.85), rgba(245,158,11,.45)); color: white; border-color: rgba(255,255,255,.95); }

    .main{
      padding:18px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 860px){
      .main{ grid-template-columns: 1fr; }
    }
    .panel{
      background: var(--panel);
      border: 2px solid rgba(255,255,255,.8);
      border-radius: var(--radius);
      box-shadow: 0 14px 28px rgba(2,6,23,.10);
      padding:14px;
    }
    .panel h2{
      margin:0 0 10px 0;
      font-size:16px;
      color:#0f172a;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .badge{
      font-size:12px;
      font-weight:800;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.8);
      border: 2px solid rgba(255,255,255,.9);
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
    }
    .card{
      background: var(--card);
      border: 2px solid rgba(255,255,255,.9);
      border-radius: var(--radius);
      padding:16px;
      display:grid;
      gap:10px;
      box-shadow: 0 14px 28px rgba(2,6,23,.10);
    }
    .bigWord{
      font-size:34px;
      font-weight:900;
      letter-spacing:.3px;
      text-align:center;
      margin:4px 0 0 0;
    }
    .hint{
      text-align:center;
      color: var(--muted);
      font-size:13px;
      line-height: 1.35;
    }
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
    }
    .status{ display:grid; gap:10px; }
    .pill{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.75);
      border:2px solid rgba(255,255,255,.9);
      color: rgba(15,23,42,.75);
      font-size:13px;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
    }
    .pill b{ color:#0f172a; }
    .msg{
      padding:10px 12px;
      border-radius: 16px;
      border:2px dashed rgba(15,23,42,.22);
      color: rgba(15,23,42,.8);
      font-size:13px;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      background: rgba(255,255,255,.65);
    }
    .msg.good{ border-color: rgba(34,197,94,.45); color: #166534; background: rgba(220,252,231,.65); }
    .msg.bad{ border-color: rgba(251,113,133,.55); color: #9f1239; background: rgba(255,228,230,.70); }

    .options{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:8px;
    }
    @media (max-width: 520px){
      .options{ grid-template-columns: 1fr; }
    }
    .opt{
      padding:12px;
      border-radius: 16px;
      border:2px solid rgba(255,255,255,.9);
      background: rgba(255,255,255,.72);
      cursor:pointer;
      text-align:center;
      font-weight:850;
      transition: transform .05s ease, filter .2s ease;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
      user-select:none;
    }
    .opt:hover{ filter: brightness(1.03) saturate(1.05); }
    .opt:active{ transform: translateY(1px); }
    .opt.correct{ border-color: rgba(34,197,94,.55); background: rgba(220,252,231,.75); }
    .opt.wrong{ border-color: rgba(251,113,133,.6); background: rgba(255,228,230,.75); }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 860px){ .grid{ grid-template-columns: repeat(4, 1fr); } }
    @media (max-width: 520px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
    .tile{
      border-radius: 16px;
      border:2px solid rgba(255,255,255,.9);
      background: rgba(255,255,255,.72);
      padding:14px 10px;
      text-align:center;
      font-weight:900;
      min-height:54px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      transition: transform .05s ease, filter .2s ease;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
    }
    .tile:active{ transform: translateY(1px); }
    .tile.revealed{ background: rgba(219,234,254,.75); border-color: rgba(59,130,246,.25); }
    .tile.matched{ background: rgba(220,252,231,.75); border-color: rgba(34,197,94,.40); cursor:default; opacity:.97; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      border:2px solid rgba(15,23,42,.18);
      padding:2px 6px;
      border-radius:10px;
      color: #0f172a;
      background: rgba(255,255,255,.7);
      font-size: 12px;
      font-weight: 800;
    }
    .footer{
      padding:12px 18px 16px 18px;
      color: rgba(15,23,42,.75);
      border-top: 2px solid rgba(255,255,255,.75);
      background: rgba(255,255,255,.45);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    /* Grammar: sentence builder chips */
    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:6px;
    }
    .chip{
      padding:8px 10px;
      border-radius: 999px;
      border:2px solid rgba(255,255,255,.9);
      background: rgba(255,255,255,.72);
      cursor:pointer;
      font-weight:900;
      box-shadow: 0 10px 18px rgba(2,6,23,.06);
      user-select:none;
    }
    .chip.used{ opacity:.45; cursor:default; text-decoration: line-through; }
    .answerBar{
      min-height:52px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:center;
      align-items:center;
      padding:10px;
      border-radius: 16px;
      border:2px dashed rgba(15,23,42,.22);
      background: rgba(255,255,255,.60);
    }
    .answerBar .chip{ cursor:default; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <h1><span class="spark">‚ú®</span> Oxford (2¬∫ Primaria) ‚Äî Tema 3</h1>
        <small>Things I can do ¬∑ Flashcards ¬∑ Quiz ES‚ÜíEN ¬∑ Spelling ¬∑ Memory ¬∑ Grammar (can/can‚Äôt)</small>
      </div>
      <div class="controls">
        <select id="mode">
          <option value="flash">Flashcards</option>
          <option value="quiz">Quiz (ES ‚Üí EN)</option>
          <option value="spell">Spelling (escribe)</option>
          <option value="memory">Memory (parejas)</option>
          <option value="grammar">Grammar (can / can't)</option>
        </select>
        <select id="group">
          <option value="all">All words</option>
          <option value="actions">Actions</option>
          <option value="sports">Sports</option>
          <option value="arts">Arts</option>
          <option value="extras">Extras</option>
        </select>
        <button id="reset" class="btn-b">Reset</button>
      </div>
    </header>

    <div class="main">
      <section class="panel">
        <h2 id="panelTitle">Flashcards <span class="badge" id="subBadge">EN ‚Üí ES</span></h2>
        <div id="stage" class="card"></div>
      </section>

      <aside class="panel status">
        <h2>Progress <span class="badge">‚≠ê</span></h2>
        <div class="pill"><span>Score</span><b id="score">0</b></div>
        <div class="pill"><span>Correct</span><b id="correct">0</b></div>
        <div class="pill"><span>Wrong</span><b id="wrong">0</b></div>
        <div class="pill"><span>Streak</span><b id="streak">0</b></div>
        <div class="pill"><span>Words in set</span><b id="count">0</b></div>
        <div id="message" class="msg">Elige modo y empieza üôÇ</div>

        <div class="card" style="padding:12px">
          <div class="hint" style="margin:0">
            Atajos: <span class="kbd">N</span> next ¬∑ <span class="kbd">S</span> speak ¬∑ <span class="kbd">R</span> reset
          </div>
        </div>
      </aside>
    </div>

    <div class="footer">
      <div>Incluye acciones del ‚ÄúTema 3‚Äù tipo <b>can / can't</b>: dance, swim, jump, ride a bike, play football‚Ä¶ (adaptado a nivel 2¬∫ Primaria).</div>
      <div>Pronunciaci√≥n: bot√≥n üîä (si el navegador lo permite).</div>
    </div>
  </div>

<script>
(() => {
  // Vocabulario sugerido para "Things I can do" (2¬∫ Primaria)
  const WORDS = {
    actions: [
      { en: "run", es: "correr" },
      { en: "jump", es: "saltar" },
      { en: "swim", es: "nadar" },
      { en: "dance", es: "bailar" },
      { en: "sing", es: "cantar" },
      { en: "read", es: "leer" },
      { en: "write", es: "escribir" },
      { en: "ride a bike", es: "montar en bici" },
    ],
    sports: [
      { en: "play football", es: "jugar al f√∫tbol" },
      { en: "play basketball", es: "jugar al baloncesto" },
      { en: "play tennis", es: "jugar al tenis" },
      { en: "jump rope", es: "saltar a la comba" },
      { en: "skate", es: "patinar" },
      { en: "kick a ball", es: "dar una patada a una pelota" },
    ],
    arts: [
      { en: "draw", es: "dibujar" },
      { en: "paint", es: "pintar" },
      { en: "play the piano", es: "tocar el piano" },
      { en: "play the guitar", es: "tocar la guitarra" },
      { en: "do a puzzle", es: "hacer un puzle" },
      { en: "take photos", es: "hacer fotos" },
    ],
    extras: [
      { en: "climb", es: "escalar / trepar" },
      { en: "cook", es: "cocinar" },
      { en: "help at home", es: "ayudar en casa" },
      { en: "tidy up", es: "recoger / ordenar" },
    ]
  };

  // Grammar: can / can't (affirmative, negative, questions)
  const GRAMMAR = [
    { type: "choose", es: "Yo ___ nadar.", base: "I ___ swim.", answer: "can" },
    { type: "choose", es: "Yo ___ volar.", base: "I ___ fly.", answer: "can't" },
    { type: "choose", es: "Ella ___ bailar.", base: "She ___ dance.", answer: "can" },
    { type: "choose", es: "√âl ___ conducir un coche.", base: "He ___ drive a car.", answer: "can't" },
    { type: "choose", es: "Nosotros ___ jugar al f√∫tbol.", base: "We ___ play football.", answer: "can" },
    { type: "choose", es: "Ellos ___ nadar.", base: "They ___ swim.", answer: "can" },
    { type: "choose", es: "T√∫ ___ saltar muy alto.", base: "You ___ jump very high.", answer: "can" },
    { type: "choose", es: "El beb√© ___ montar en bici.", base: "The baby ___ ride a bike.", answer: "can't" },

    { type: "order", es: "Ordena la pregunta:", words: ["Can", "you", "swim", "?"], answer: "Can you swim ?" },
    { type: "order", es: "Ordena la respuesta:", words: ["Yes,", "I", "can", "."], answer: "Yes, I can ." },
    { type: "order", es: "Ordena la respuesta:", words: ["No,", "I", "can't", "."], answer: "No, I can't ." },
    { type: "order", es: "Ordena la frase:", words: ["I", "can", "ride", "a", "bike", "."], answer: "I can ride a bike ." },
    { type: "order", es: "Ordena la frase:", words: ["She", "can't", "swim", "."], answer: "She can't swim ." },
  ];

  const $ = (s) => document.querySelector(s);
  const modeEl = $("#mode");
  const groupEl = $("#group");
  const resetEl = $("#reset");
  const stageEl = $("#stage");
  const panelTitleEl = $("#panelTitle");
  const subBadgeEl = $("#subBadge");
  const msgEl = $("#message");

  const scoreEl = $("#score");
  const correctEl = $("#correct");
  const wrongEl = $("#wrong");
  const streakEl = $("#streak");
  const countEl = $("#count");

  let score = 0, correct = 0, wrong = 0, streak = 0;
  let current = null;
  let quizLocked = false;

  let mem = { deck: [], revealed: [], matched: new Set(), lock: false };

  function setMessage(text, type = "") {
    msgEl.className = "msg" + (type ? " " + type : "");
    msgEl.textContent = text;
  }

  function updateStats() {
    scoreEl.textContent = score;
    correctEl.textContent = correct;
    wrongEl.textContent = wrong;
    streakEl.textContent = streak;

    // Grammar no depende de "words", pero mostramos el tama√±o del set para todo
    const m = modeEl.value;
    countEl.textContent = (m === "grammar") ? GRAMMAR.length : getWordList().length;
  }

  function getWordList() {
    const g = groupEl.value;
    if (g === "actions") return WORDS.actions.slice();
    if (g === "sports") return WORDS.sports.slice();
    if (g === "arts") return WORDS.arts.slice();
    if (g === "extras") return WORDS.extras.slice();
    return [...WORDS.actions, ...WORDS.sports, ...WORDS.arts, ...WORDS.extras];
  }

  function randInt(n) { return Math.floor(Math.random() * n); }
  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = randInt(i + 1);
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function pickNewWord() {
    const list = getWordList();
    current = list[randInt(list.length)];
    return current;
  }

  function speak(text) {
    if (!("speechSynthesis" in window)) {
      setMessage("Tu navegador no tiene pronunciaci√≥n (SpeechSynthesis).", "bad");
      return;
    }
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = 0.95;
    window.speechSynthesis.speak(u);
  }

  function resetProgress() {
    score = 0; correct = 0; wrong = 0; streak = 0;
    quizLocked = false;
    mem = { deck: [], revealed: [], matched: new Set(), lock: false };
    updateStats();
    setMessage("Progreso reiniciado.", "");
    render();
  }

  // typo generator for ES‚ÜíEN options
  function makeTypos(word) {
    const w = word.toLowerCase();
    const typos = new Set();

    // swap adjacent
    if (w.length >= 4) {
      const i = randInt(w.length - 1);
      const s = w.split("");
      [s[i], s[i+1]] = [s[i+1], s[i]];
      typos.add(s.join(""));
    }

    // replace vowel
    const vowels = ["a","e","i","o","u"];
    const idxs = [];
    for (let i=0;i<w.length;i++){
      if (vowels.includes(w[i])) idxs.push(i);
    }
    if (idxs.length){
      const i = idxs[randInt(idxs.length)];
      const v = vowels[randInt(vowels.length)];
      const s = w.split("");
      s[i] = v;
      typos.add(s.join(""));
    }

    // remove letter
    if (w.length >= 4) {
      const i = randInt(w.length);
      typos.add(w.slice(0,i) + w.slice(i+1));
    }

    // add vowel somewhere
    if (w.length >= 3) {
      const i = randInt(w.length+1);
      const letters = "aeiou";
      const ch = letters[randInt(letters.length)];
      typos.add(w.slice(0,i) + ch + w.slice(i));
    }

    // last letter change
    if (w.length >= 3) {
      const letters = "abcdefghijklmnopqrstuvwxyz";
      const ch = letters[randInt(letters.length)];
      typos.add(w.slice(0,-1) + ch);
    }

    typos.delete(w);
    return Array.from(typos).filter(t => t.length >= 3 && t.length <= 16);
  }

  function renderFlash() {
    subBadgeEl.textContent = "EN ‚Üí ES";
    panelTitleEl.childNodes[0].nodeValue = "Flashcards ";
    const w = pickNewWord();

    stageEl.innerHTML = `
      <div class="bigWord">${w.en}</div>
      <div class="hint">¬øQu√© significa en espa√±ol?</div>
      <div class="row">
        <button id="reveal" class="btn-a">Reveal</button>
        <button id="speakBtn" class="btn-d">Speak üîä</button>
        <button id="next" class="btn-c">Next</button>
      </div>
      <div id="answer" class="hint" style="font-size:15px; display:none; margin-top:6px;"></div>
    `;

    $("#reveal").onclick = () => {
      const a = $("#answer");
      a.style.display = "block";
      a.textContent = `= ${w.es}`;
      setMessage("¬°Genial! Ahora pulsa Next.", "good");
    };
    $("#speakBtn").onclick = () => speak(w.en);
    $("#next").onclick = () => {
      setMessage("Siguiente‚Ä¶", "");
      renderFlash();
    };
  }

  function renderQuiz() {
    subBadgeEl.textContent = "ES ‚Üí EN";
    panelTitleEl.childNodes[0].nodeValue = "Quiz ";
    const list = getWordList();
    const w = pickNewWord();
    quizLocked = false;

    const options = new Set([w.en.toLowerCase()]);

    const typos = makeTypos(w.en);
    shuffle(typos);
    for (const t of typos) {
      if (options.size >= 4) break;
      options.add(t);
    }

    const otherPool = list.map(x => x.en.toLowerCase()).filter(x => x !== w.en.toLowerCase());
    shuffle(otherPool);
    for (const o of otherPool) {
      if (options.size >= 4) break;
      options.add(o);
    }

    const opts = shuffle(Array.from(options)).slice(0,4);

    stageEl.innerHTML = `
      <div class="hint">Pregunta en espa√±ol:</div>
      <div class="bigWord">${w.es}</div>
      <div class="hint">Elige la palabra correcta en ingl√©s:</div>
      <div class="options">
        ${opts.map((o) => `<div class="opt" data-val="${o}">${o}</div>`).join("")}
      </div>
      <div class="row" style="margin-top:10px">
        <button id="speakBtn" class="btn-d">Speak correct üîä</button>
        <button id="next" class="btn-c">Next</button>
      </div>
      <div class="hint" style="margin-top:6px">Tip: a veces ver√°s ‚Äútrampas‚Äù (typos) para entrenar la ortograf√≠a üôÇ</div>
    `;

    $("#speakBtn").onclick = () => speak(w.en);
    $("#next").onclick = () => renderQuiz();

    stageEl.querySelectorAll(".opt").forEach(opt => {
      opt.addEventListener("click", () => {
        if (quizLocked) return;
        quizLocked = true;

        const chosen = opt.getAttribute("data-val");
        const target = w.en.toLowerCase();
        const isCorrect = chosen === target;

        stageEl.querySelectorAll(".opt").forEach(o => {
          if (o.getAttribute("data-val") === target) o.classList.add("correct");
        });

        if (isCorrect) {
          opt.classList.add("correct");
          correct++; streak++; score += 10 + Math.min(10, streak);
          setMessage("‚úÖ Correct!", "good");
          speak(w.en);
        } else {
          opt.classList.add("wrong");
          wrong++; streak = 0; score = Math.max(0, score - 3);
          setMessage(`‚ùå Wrong. Correct: ${w.en}`, "bad");
        }
        updateStats();
      });
    });
  }

  function renderSpelling() {
    subBadgeEl.textContent = "ES ‚Üí EN";
    panelTitleEl.childNodes[0].nodeValue = "Spelling ";
    const w = pickNewWord();

    stageEl.innerHTML = `
      <div class="hint">Escribe en ingl√©s:</div>
      <div class="bigWord">${w.es}</div>
      <div class="hint">Ejemplo: <b>nadar</b> ‚Üí swim</div>
      <div class="row" style="margin-top:6px">
        <input id="spellIn" autocomplete="off" placeholder="Type the English words‚Ä¶" style="width:min(460px, 100%); text-align:center;" />
      </div>
      <div class="row" style="margin-top:10px">
        <button id="check" class="btn-a">Check</button>
        <button id="show" class="btn-e">Show answer</button>
        <button id="speakBtn" class="btn-d">Speak üîä</button>
        <button id="next" class="btn-c">Next</button>
      </div>
      <div id="spellAns" class="hint" style="font-size:15px; display:none; margin-top:6px;"></div>
    `;

    const input = $("#spellIn");
    input.focus();

    function normalize(s){ return (s||"").trim().toLowerCase(); }

    function check() {
      const typed = normalize(input.value);
      const target = normalize(w.en);
      if (!typed) return;

      if (typed === target) {
        correct++; streak++; score += 12 + Math.min(12, streak);
        setMessage("‚úÖ Perfect spelling!", "good");
        speak(w.en);
      } else {
        wrong++; streak = 0; score = Math.max(0, score - 3);
        setMessage(`‚ùå Not quite. Correct: ${w.en}`, "bad");
      }
      updateStats();
    }

    $("#check").onclick = check;
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") check();
    });

    $("#show").onclick = () => {
      const a = $("#spellAns");
      a.style.display = "block";
      a.textContent = `Answer: ${w.en}`;
    };
    $("#speakBtn").onclick = () => speak(w.en);
    $("#next").onclick = () => renderSpelling();
  }

  function renderMemory() {
    subBadgeEl.textContent = "EN ‚Üî ES";
    panelTitleEl.childNodes[0].nodeValue = "Memory ";
    const list = getWordList();

    const deck = [];
    list.forEach((w, idx) => {
      deck.push({ pair: idx, text: w.en, kind: "en" });
      deck.push({ pair: idx, text: w.es, kind: "es" });
    });
    shuffle(deck);

    mem.deck = deck;
    mem.revealed = [];
    mem.matched = new Set();
    mem.lock = false;

    setMessage("Encuentra las parejas (ingl√©s-espa√±ol).", "");

    stageEl.innerHTML = `
      <div class="hint">Toca dos cartas. Si coinciden, ¬°se quedan!</div>
      <div class="grid" id="grid"></div>
      <div class="row" style="margin-top:10px">
        <button id="restartMem" class="btn-a">Shuffle</button>
        <button id="speakMem" class="btn-d">Speak revealed üîä</button>
      </div>
    `;

    $("#restartMem").onclick = () => renderMemory();
    $("#speakMem").onclick = () => {
      const last = mem.revealed[mem.revealed.length - 1];
      if (last && last.card.kind === "en") speak(last.card.text);
    };

    const grid = $("#grid");

    function draw() {
      grid.innerHTML = "";
      mem.deck.forEach((card, i) => {
        const isMatched = mem.matched.has(card.pair);
        const isRevealed = mem.revealed.some(r => r.i === i);
        const showText = isMatched || isRevealed;

        const div = document.createElement("div");
        div.className = "tile" + (isMatched ? " matched" : (isRevealed ? " revealed" : ""));
        div.textContent = showText ? card.text : "‚ùì";
        div.onclick = () => onPick(i);
        grid.appendChild(div);
      });
    }

    function onPick(i) {
      if (mem.lock) return;

      const card = mem.deck[i];
      if (mem.matched.has(card.pair)) return;
      if (mem.revealed.some(r => r.i === i)) return;

      mem.revealed.push({ i, card });

      if (mem.revealed.length === 2) {
        mem.lock = true;
        const [a, b] = mem.revealed;
        const samePair = a.card.pair === b.card.pair && a.card.kind !== b.card.kind;

        draw();

        if (samePair) {
          mem.matched.add(a.card.pair);
          correct++; streak++; score += 8 + Math.min(8, streak);
          setMessage("‚úÖ Match!", "good");
          mem.revealed = [];
          mem.lock = false;
          updateStats();
          draw();

          if (mem.matched.size === list.length) {
            setMessage("üèÅ ¬°Completado! Has encontrado todas las parejas.", "good");
          }
        } else {
          wrong++; streak = 0; score = Math.max(0, score - 2);
          setMessage("‚ùå No match. Int√©ntalo otra vez.", "bad");
          updateStats();
          setTimeout(() => {
            mem.revealed = [];
            mem.lock = false;
            draw();
          }, 700);
        }
      } else {
        draw();
      }
    }

    draw();
  }

  function pickGrammar() {
    const item = GRAMMAR[randInt(GRAMMAR.length)];
    return JSON.parse(JSON.stringify(item)); // clone
  }

  function renderGrammar() {
    subBadgeEl.textContent = "can / can't";
    panelTitleEl.childNodes[0].nodeValue = "Grammar ";
    quizLocked = false;

    const g = pickGrammar();

    if (g.type === "choose") {
      stageEl.innerHTML = `
        <div class="hint">Completa con <b>can</b> o <b>can't</b>:</div>
        <div class="bigWord">${g.base.replace("___", "___")}</div>
        <div class="hint" style="margin-top:-4px">Ayuda (ES): ${g.es}</div>
        <div class="options">
          <div class="opt" data-val="can">can ‚úÖ</div>
          <div class="opt" data-val="can't">can't ‚ùå</div>
          <div class="opt" data-val="can‚Äôt">can‚Äôt (apostrophe) ‚ùå</div>
          <div class="opt" data-val="cant">cant ‚ùå</div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="speakBtn" class="btn-d">Speak sentence üîä</button>
          <button id="next" class="btn-c">Next</button>
        </div>
        <div class="hint" style="margin-top:6px">Regla r√°pida: <b>I/you/we/they/he/she + can</b> (no cambia) ¬∑ negativo: <b>can't</b>.</div>
      `;

      const target = g.answer; // "can" or "can't"
      const sentence = g.base.replace("___", target);

      $("#speakBtn").onclick = () => speak(sentence.replace(" ?", "?").replace(" .", "."));
      $("#next").onclick = () => renderGrammar();

      stageEl.querySelectorAll(".opt").forEach(opt => {
        opt.addEventListener("click", () => {
          if (quizLocked) return;
          quizLocked = true;

          const chosen = opt.getAttribute("data-val");
          const ok = (chosen === target);

          stageEl.querySelectorAll(".opt").forEach(o => {
            if (o.getAttribute("data-val") === target) o.classList.add("correct");
          });

          if (ok) {
            opt.classList.add("correct");
            correct++; streak++; score += 11 + Math.min(10, streak);
            setMessage("‚úÖ Perfect! (Grammar)", "good");
            speak(sentence.replace(" ?", "?").replace(" .", "."));
          } else {
            opt.classList.add("wrong");
            wrong++; streak = 0; score = Math.max(0, score - 3);
            setMessage(`‚ùå Not quite. Correct: ${sentence}`, "bad");
          }
          updateStats();
        });
      });

      return;
    }

    // type === "order": build sentence by tapping words
    const words = shuffle(g.words.slice());
    const picked = [];

    stageEl.innerHTML = `
      <div class="hint">${g.es}</div>
      <div class="hint">Toca las palabras para formar la frase:</div>

      <div class="answerBar" id="answerBar"></div>

      <div class="chips" id="chips"></div>

      <div class="row" style="margin-top:10px">
        <button id="undo" class="btn-e">Undo</button>
        <button id="clear" class="btn-b">Clear</button>
        <button id="checkG" class="btn-a">Check</button>
        <button id="next" class="btn-c">Next</button>
        <button id="speakBtn" class="btn-d">Speak üîä</button>
      </div>

      <div class="hint" style="margin-top:6px">Consejo: en preguntas suele ir <b>Can</b> al principio üôÇ</div>
    `;

    const chipsEl = $("#chips");
    const barEl = $("#answerBar");

    function redraw() {
      barEl.innerHTML = picked.map(w => `<span class="chip">${w}</span>`).join("");
      chipsEl.innerHTML = "";
      words.forEach((w, idx) => {
        const used = picked.includes(w) && countIn(picked, w) >= countInPickedPos(w);
        const span = document.createElement("span");
        span.className = "chip" + (used ? " used" : "");
        span.textContent = w;
        span.onclick = () => {
          if (span.classList.contains("used")) return;
          picked.push(w);
          redraw();
        };
        chipsEl.appendChild(span);
      });
    }

    // helpers to handle duplicate words (rare but safe)
    function countIn(arr, w){ return arr.filter(x => x === w).length; }
    function countInPickedPos(w){ return picked.filter(x => x === w).length; }

    function normalizeSentence(s){
      return s.trim()
        .replace(/\s+\?/g, " ?")
        .replace(/\s+\./g, " .")
        .replace(/\s+/g, " ");
    }

    $("#undo").onclick = () => { picked.pop(); redraw(); };
    $("#clear").onclick = () => { picked.length = 0; redraw(); };

    $("#checkG").onclick = () => {
      const built = normalizeSentence(picked.join(" "));
      const target = normalizeSentence(g.answer);
      const ok = built === target;

      if (ok) {
        correct++; streak++; score += 13 + Math.min(10, streak);
        setMessage("‚úÖ Great! Sentence is correct.", "good");
        speak(target.replace(" ?", "?").replace(" .", "."));
      } else {
        wrong++; streak = 0; score = Math.max(0, score - 3);
        setMessage(`‚ùå Try again. Correct: ${target.replace(" ?", "?").replace(" .", ".")}`, "bad");
      }
      updateStats();
    };

    $("#speakBtn").onclick = () => {
      const built = picked.length ? normalizeSentence(picked.join(" ")) : normalizeSentence(g.answer);
      speak(built.replace(" ?", "?").replace(" .", "."));
    };
    $("#next").onclick = () => renderGrammar();

    redraw();
  }

  function render() {
    updateStats();
    const m = modeEl.value;
    if (m === "flash") return renderFlash();
    if (m === "quiz") return renderQuiz();
    if (m === "spell") return renderSpelling();
    if (m === "memory") return renderMemory();
    if (m === "grammar") return renderGrammar();
  }

  modeEl.addEventListener("change", () => { setMessage("Modo cambiado.", ""); render(); });
  groupEl.addEventListener("change", () => { setMessage("Conjunto cambiado.", ""); render(); });
  resetEl.addEventListener("click", resetProgress);

  window.addEventListener("keydown", (e) => {
    const k = e.key.toLowerCase();
    if (k === "r") resetProgress();
    if (k === "n") render();
    if (k === "s" && current?.en) speak(current.en);
  });

  updateStats();
  setMessage("Empieza con Flashcards üôÇ", "");
  render();
})();
</script>
</body>
</html>
